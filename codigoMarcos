#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct {
    char usuario[20];
    char senha[10];
}login;

typedef struct {
    char CRM[7];
    char nome[50];
    char especialidade[20];
    char data_de_nascimento[12];
    float valor_hora_trabalho;
    char telefone[14];
}medico;

typedef struct {
    char CPF[12];
    char nome[30];
    char data_de_nascimento[12];
    char telefone[14];
}paciente;

typedef struct {
    char crm_medico[7];
    char cpf_paciente[12];
    char data[12];
    char sintomas[100];
    char encaminhamentos[100];
}consulta;

typedef struct {
    int posicao; // Posição do registro no arquivo binário
    char chave[7]; // CPF ou CRM
}IndexMedico;

typedef struct {
    char chave[12]; // CPF ou CRM
    int posicao; // Posição do registro no arquivo binário
}IndexPaciente;

void troca(IndexMedico *v, int i, int j);

int encontrarPosicaoInsercao(IndexMedico *v, int tam, char *crm);

void quicksort(IndexMedico *v, int L, int R);

void criarVetorMedicos();

void salvarVetorIndexMedico(IndexMedico * v, int tam);

IndexMedico * lerArquivoIndexMedico();

void ordenarIndexMedicos(IndexMedico *v, int tam);

int buscaBinaria(IndexMedico *v, int tam, char *x);
//DECLARANDO FUNÇÕES LOGIN

void CadastrarNovoUsuario();

int VerificarLogin(char *senha, char *usuario);

int EfetuarLogin();

int VerificarUsuario(char *usuario);

//DECLARANDO FUNÇÕES PACIENTE

void BuscarPacientePorNome();

void AlterarDadosPaciente();

void InserirNovoPaciente();

//DECLARANDO FUNÇÕES MEDICO

void InserirNovoMedico();

void BuscarMedicoPorNome();

int ValidarPaciente(char *cpf);

int ValidarMedico(char *CRM);

//DECLARANDO FUNÇÔES CONSULTA

void InserirNovaConsulta();

void ListarConsultasPorMedico();

void ListarConsultasPorPaciente();

void ListarConsultasPorData();

IndexMedico *v = NULL;

int count = 0;


int main(){
    int opcaoMenuInicial, validarLogin = 1, opcaoMenuLogin, opcaoMenuLoginSec;

    //FILE *pointMed, *pointPac;
    //pointMed = fopen("indiceMedicos.bin", );
    v = lerArquivoIndexMedico();

    if(v == NULL){
        criarVetorMedicos();
    }

    for(int i = 0; i < count; i++){
        printf("%s\n", v[i].chave);
        printf("%d\n", i);
    }

    /*for(int i = 0; i < 2; i++){
        printf("\n %s", v[i].chave);
        printf("\n %d", v[i].posicao);
    }*/


    do{
        printf("\n-----MENU INICIAL-----");
        printf("\n1 - Efetuar Login");
        printf("\n2- Cadastrar Usuário");
        printf("\n0- Encerrar Programa");
        printf("\nSelecione uma das opcoes acima: ");
        scanf("%d", &opcaoMenuInicial);

        switch(opcaoMenuInicial){
        case 0:
            printf("\nEncerrando Programa...");
            opcaoMenuInicial = 0;
        break;
        case 1:
            validarLogin = EfetuarLogin();

            if(validarLogin == 1){
                do{
                    printf("\n-----MENU-----");
                    printf("\n1 - Pacientes\n2 - Medicos\n3 - Consultas\n0 - Voltar");
                    printf("\nSelecione uma das opcoes acima: ");
                    scanf("%d", &opcaoMenuLogin);

                    switch(opcaoMenuLogin){
                    case 0:
                        opcaoMenuLogin = 0;
                    break;
                    case 1:
                        do{
                            printf("\n-----MENU PACIENTE-----");
                            printf("\n1 - Cadastrar Paciente\n2 - Buscar Paciente (Por Nome)\n3 - Alterar Dados do Paciente\n0 - Voltar");
                            printf("\nSelecione uma das opcoes acima: ");
                            scanf("%d", &opcaoMenuLoginSec);

                            switch(opcaoMenuLoginSec){
                                case 0:
                                    opcaoMenuLoginSec = 0;
                                break;
                                case 1:
                                    InserirNovoPaciente();
                                break;
                                case 2:
                                    BuscarPacientePorNome();
                                break;
                                case 3:
                                    AlterarDadosPaciente();
                                break;
                                default:
                                    printf("\nOpcao invalida!");
                                break;
                            }

                        }while(opcaoMenuLoginSec != 0);
                    break;
                    case 2:
                        do{
                            printf("\n-----MENU MEDICO-----");
                            printf("\n1 - Cadastrar Medico\n2 - Buscar Medico (Por Nome)\n3 - Listar Medico por Especialidade\n4 - Alterar Dados do Medico\n0 - Voltar");
                            printf("\nSelecione uma das opcoes acima: ");
                            scanf("%d", &opcaoMenuLoginSec);

                            switch(opcaoMenuLoginSec){
                            case 0:
                                opcaoMenuLoginSec = 0;
                            break;
                            case 1:
                                InserirNovoMedico();
                            break;
                            case 2:
                                BuscarMedicoPorNome();
                            break;
                            case 3:

                            break;
                            case 4:

                            break;
                            default:
                                printf("\nOpcao invalida!");
                            break;
                            }
                        }while(opcaoMenuLoginSec != 0);
                    break;
                    case 3:
                        do{
                            printf("\n-----MENU CONSULTAS-----");
                            printf("\n1 - Cadastrar Consulta\n2 - Listar Consultas (Por Medico)\n3 - Listar Consultas (Por Paciente)\n4 - Listar Consultas (Por Data)\n0 - Voltar");
                            printf("\nSelecione uma das opcoes acima: ");
                            scanf("%d", &opcaoMenuLoginSec);

                            switch(opcaoMenuLoginSec){
                                case 0:
                                    opcaoMenuLoginSec = 0;
                                break;
                                case 1:
                                    InserirNovaConsulta();
                                break;
                                case 2:
                                    ListarConsultasPorMedico();
                                break;
                                case 3:
                                    ListarConsultasPorPaciente();
                                break;
                                case 4:
                                    ListarConsultasPorData();
                                break;
                                default:
                                    printf("\nOpcao invalida!");
                                break;
                            }
                        }while(opcaoMenuLoginSec != 0);
                    break;
                    default:
                        printf("Opcao invalida!");
                    break;
                }
            }while(opcaoMenuLogin != 0);
        }
        else{
            validarLogin = 0;
        }
        break;
        case 2:
            CadastrarNovoUsuario(); //tem que completar aqui ainda quando as funções tiverem prontas
        break;
        default:
            printf("\nOpcao invalida tente novamente");
        break;
        }
    } while (opcaoMenuInicial != 0 && validarLogin != 0);

    salvarVetorIndexMedico(v,count);

    free(v);

    return 0;
}

int encontrarPosicaoInsercao(IndexMedico *v, int tam, char *crm) {
    int i = 0, f = tam - 1, meio;

    while (i <= f) {
        meio = (i + f) / 2;

        if (strcmp(v[meio].chave, crm) == 0) {
            return meio;
        }
        if (strcmp(crm, v[meio].chave) > 0) {
            i = meio + 1;
        } else {
            f = meio - 1;
        }
    }
    return i;
}

void ordenarIndexMedicos(IndexMedico *v, int tam){
    quicksort(v, 0, tam);
}

void salvarVetorIndexMedico(IndexMedico * v, int tam){
    FILE *point;
    int i = 0;

    point = fopen("IndexMedico.bin", "wb");

    while(fwrite(&v[i], sizeof(IndexMedico), 1, point) == 1){
            i++;
        }
    fclose(point);
}

IndexMedico * lerArquivoIndexMedico(){

// é chamada sempre no incio do programa
// ler o vetor de medicos que está no arquivo indexmedico.bin e
// criar o vetor na memoria RAM
// retorn o vetor com os dados
    int i = 0;
    IndexMedico m;
    FILE *point;
    point = fopen("IndexMedico.bin", "rb");

    while(fread(&m, sizeof(IndexMedico), 1, point) == 1){
        count++;
    }

    if(count == 0){
        return 0;
    }

    v = (IndexMedico *) malloc(count * sizeof(IndexMedico));

    fseek(point, 0, SEEK_SET);

    while(fread(&m, sizeof(IndexMedico), 1, point) == 1){
            strcpy(v[i].chave, m.chave);
            v[i].posicao= m.posicao;
            i++;
        }
    fclose(point);
    return v;

}

void criarVetorMedicos(char *crm){
    FILE *point1;
    medico m;

    int i = 0, posicao = encontrarPosicaoInsercao(v, count, crm);
    count++;

    point1 = fopen("medicos.bin", "rb");

    if(count != 0)
        v = (IndexMedico *) realloc(v, count * sizeof(IndexMedico));
    else
        v = (IndexMedico *) malloc(1 *sizeof(IndexMedico));

    for (int i = count - 1; i > posicao; i--) {
        v[i] = v[i - 1];
    }
    strcpy(v[count].chave, crm);
    //v[i].posicao = ftell(point1) - sizeof(IndexMedico);

    ordenarIndexMedicos(v, count);
    fclose(point1);
}

void troca(IndexMedico *v, int i, int j)
{
  IndexMedico aux;
  aux = v[i];
  v[i] = v[j];
  v[j] = aux;
}

void quicksort(IndexMedico *v, int L, int R){
  int i,j;
  IndexMedico vm;
  i = L;
  j = R;
  vm = v[(int)(i+j)/2];
  do {
    while (strcmp(v[i].chave, vm.chave)<0) i++;
    while (strcmp(v[j].chave, vm.chave)>0) j--;
    if (i <= j){
      troca(v,i,j);
      i++;
      j--;
     }
   } while (i <= j);
   if (L < j) quicksort(v,L,j);
   if (R > i) quicksort(v,i,R);
 }

//FUNCOES MENU INICIAL

int VerificarUsuario(char *usuario){

    FILE *pont;
    login log;

    pont = fopen("login.bin", "rb");

    while(fread(&log, sizeof(login), 1, pont) == 1){
        if(strcmp(log.usuario, usuario) == 0){
            return 1;
        }
    }
    fclose(pont);

    return 0;
}

int EfetuarLogin(){
    login log;
    int tentativa = 0;

    printf("\n-----LOGIN-----");
    do{
        printf("\nDigite seu usuario: ");
        scanf(" %[^\n]", log.usuario);
        printf("\nDigite sua senha: ");
        scanf(" %[^\n]", log.senha);

        if(VerificarLogin(log.senha, log.usuario) != 1){
            printf("\nErro: usuario ou senha invalidos");
            tentativa++;
        }
        else{
            printf("\nLogin autenticado!");
            return 1;
        }

    }while(tentativa < 3);

    printf("\nMaximo de tentativas alcancada!");
    return 0;
}

int VerificarLogin(char *senha, char *usuario){

    FILE *pont;
    login log;

    pont = fopen("login.bin", "rb");

    while(fread(&log, sizeof(login), 1, pont) == 1){
        if(strcmp(log.usuario, usuario) == 0 && strcmp(log.senha, senha) == 0){
            return 1;
        }
    }
    fclose(pont);

    return 0;
}

void CadastrarNovoUsuario(){
    FILE *arq_login;
    login log;

    arq_login = fopen("login.bin", "ab");

    if(arq_login == NULL){
        printf("Nenhum arquivo encontrado!");
        return;
    }

    printf("\n-----CADASTRAR USUARIO-----");
    printf("\nInsira o novo usuario: ");
    scanf(" %[^\n]", log.usuario);

    printf("Insira a nova senha: ");
    scanf(" %[^\n]", log.senha);

    if(VerificarUsuario(log.usuario) != 1){
        fwrite(&log, sizeof(login), 1, arq_login);
        fclose(arq_login);

        printf("\nUsuario cadastrado");
    }
    else{
        printf("\nUsuario ja existente!");
    }
}

//FUNCOES MENU MEDICOS

int ValidarMedico(char *CRM){

    for(int i = 0; i < count; i++){
        if(strcmp(v[i].chave, CRM) == 0)
            return 1;
    }

    printf("\nMedico nao encontrado!");
    return 0;
}

void InserirNovoMedico() {
    FILE *arq = fopen("medicos.bin", "ab");
    medico m;

    if (arq == NULL) return;

    printf("\n-----CADASTRAR MEDICO-----");
    printf("\nDigite o CRM do medico: ");
    scanf(" %[^\n]", m.CRM);
    printf("Digite o nome do medico: ");
    scanf(" %[^\n]", m.nome);
    printf("Digite a especialidade do medico: ");
    scanf(" %[^\n]", m.especialidade);
    printf("Digite a data de nascimento do medico: ");
    scanf(" %[^\n]", m.data_de_nascimento);
    printf("Digite o valor da hora trabalhada pelo medico: ");
    scanf("%f", &m.valor_hora_trabalho);
    printf("Digite o telefone do medico: ");
    scanf(" %[^\n]", m.telefone);

    fwrite(&m, sizeof(medico), 1, arq);

    criarVetorMedicos(m.CRM);

    fclose(arq);
}

void BuscarMedicoPorNome(){
    FILE *arq = fopen("medicos.bin", "rb");
    medico m;
    char nomeBusca[50];

    if (arq == NULL) return;

    printf("\n-----BUSCAR MEDICO (PELO NOME)-----");
    printf("\nDigite o nome do medico para a busca: ");
    scanf(" %[^\n]", nomeBusca);

    while (fread(&m, sizeof(medico), 1, arq))
        if (strcmp(m.nome, nomeBusca) == 0)
            printf("%s %s\n", m.CRM, m.especialidade);

    fclose(arq);
}

//FUNCOES PACIENTES

int validarPaciente(char *cpf){

    FILE *point;
    paciente pacientes;

    point = fopen("pacientes.bin", "rb");

    while(fread(&pacientes, sizeof(paciente), 1, point) == 1){
        if(strcmp(pacientes.CPF, cpf) == 0){
            printf("\nPaciente encontrado!");
            return 1;
        }
    }

    printf("\nPaciente nao encontrado!");
    fclose(point);
    return 0;
}

void AlterarDadosPaciente() {
    FILE *f = fopen("pacientes.bin", "r+b");
    paciente p;
    char cpfBusca[12];

    if (!f) return;

    printf("CPF do paciente: "); scanf("%11s", cpfBusca);

    while (fread(&p, sizeof(paciente), 1, f)) {
        if (strcmp(p.CPF, cpfBusca) == 0) {
            printf("Novo telefone: "); scanf("%13s", p.telefone);
            fseek(f, -sizeof(paciente), SEEK_CUR);
            fwrite(&p, sizeof(paciente), 1, f);
            break;
        }
    }
    fclose(f);
}

void BuscarPacientePorNome() {
    FILE *f = fopen("pacientes.bin", "rb");
    paciente p;
    char nomeBusca[30];

    if (!f) return;

    printf("Nome do paciente: "); getchar(); fgets(nomeBusca, 30, stdin);

    while (fread(&p, sizeof(paciente), 1, f)) {
        if (strstr(p.nome, nomeBusca)) {
            printf("CPF: %s | Nome: %s", p.CPF, p.nome);
        }
    }
    fclose(f);
}

void InserirNovoPaciente() {
    FILE *f = fopen("pacientes.bin", "ab");
    paciente p;

    if (!f) return;

    printf("CPF: "); scanf("%11s", p.CPF);
    printf("Nome: "); getchar(); fgets(p.nome, 30, stdin);
    printf("Nascimento: "); scanf("%11s", p.data_de_nascimento);
    printf("Telefone: "); scanf("%13s", p.telefone);

    fwrite(&p, sizeof(paciente), 1, f);
    fclose(f);
}

//FUNCOES CONSULTAS

void InserirNovaConsulta() {
    FILE *f = fopen("consultas.bin", "ab");
    consulta c;

    if (!f) return;

    printf("CRM do médico: ");
    scanf(" %[^\n]", c.crm_medico);

    if(ValidarMedico(c.crm_medico) == 1){
        printf("CPF do paciente: ");
        scanf(" %[^\n]", c.cpf_paciente);
        printf("Data: ");
        scanf(" %[^\n]", c.data);
        printf("Sintomas: ");
        getchar();
        fgets(c.sintomas, 100, stdin);
        printf("Encaminhamentos: ");
        fgets(c.encaminhamentos, 100, stdin);

        fwrite(&c, sizeof(consulta), 1, f);
    }
    else
        printf("\nCRM invalido!");

    fclose(f);
}

void ListarConsultasPorMedico() {
    FILE *f = fopen("consultas.bin", "rb");
    consulta c;
    char crm[6];

    if (!f) return;

    printf("CRM do médico: "); scanf("%5s", crm);

    while (fread(&c, sizeof(consulta), 1, f)) {
        if (strcmp(c.crm_medico, crm) == 0) {
            printf("Data: %s | Paciente: %s", c.data, c.cpf_paciente);
        }
    }
    fclose(f);
}

void ListarConsultasPorPaciente() {
    FILE *f = fopen("consultas.bin", "rb");
    consulta c;
    char cpf[12];

    if (!f) return;

    printf("CPF do paciente: ");
    scanf("%11s", cpf);

    while (fread(&c, sizeof(consulta), 1, f)) {
        if (strcmp(c.cpf_paciente, cpf) == 0) {
            printf("Data: %s | Médico: %s", c.data, c.crm_medico);
        }
    }
    fclose(f);
}

void ListarConsultasPorData() {
    FILE *f = fopen("consultas.bin", "rb");
    consulta c;
    char data[12];

    if (!f) return;

    printf("Data: ");
    scanf("%11s", data);

    while (fread(&c, sizeof(consulta), 1, f)) {
        if (strcmp(c.data, data) == 0) {
            printf("Médico: %s | Paciente: %s", c.crm_medico, c.cpf_paciente);
        }
    }
    fclose(f);
}
